# shellcheck shell=bash

if [ -z "${site_base_domain}" ]; then
    abort "Site base domain is not set"
fi

repo_url="${args[repository]}"
branch="${args[branch]}"

# Handle local repositories
if realpath "${repo_url}" > /dev/null 2>&1; then
    repo_url=$(realpath "${repo_url}")
    repo=$(basename "${repo_url}")
else
    # Remove schome and host from URL
    # https://tldp.org/LDP/abs/html/string-manipulation.html
    repo="${repo_url#*://}"
    repo="${repo#*/}"
fi

# @todo Add something really unique to the site ID.
site_id=$(echo "${repo}__${branch}" | sed "s@[^a-z0-9-]@-@gi")
compose_project_name="${site_id}"

# Our nginx container exits in the upstream hostname gets too long (more than 63 characters?):
#
# 2026/01/23 23:01:07 [emerg] 1#1: host not found in upstream "rimi-itk-experiment-test-site--feature-drupal-admin-theme-phpfpm-1" in /etc/nginx/conf.d/default.conf:86
#
if [ ${#compose_project_name} -gt 32 ]; then
    compose_project_name="$(echo "${compose_project_name}" | head -c 24)-$(echo "${site_id}" | sha256sum | head -c 16)"
fi

# A valid compose project name must consist only of lowercase alphanumeric
# characters, hyphens, and underscores as well as start with a letter or
# number.
# @todo Validate the compose project name.
compose_project_name=$(echo "${compose_project_name}" | tr "[:upper:]" "[:lower:]")

project_domain="${site_id}.${site_base_domain}"
project_url="https://${project_domain}"
project_dir=$(echo "${site_base_dir}/${site_id}" | sed "s@[^a-z0-9/-]@@gi")

print_info "Fetching code for test site ${site_id}" ""

# Check out the code
if [ ! -d "${project_dir}" ]; then
    run_command git clone "${repo_url}" --branch "${branch}" "${project_dir}"
fi

cd "${project_dir}" || exit
run_command git fetch
run_command git reset --hard "origin/${branch}"
run_command git log -3

print_info "Generating ${compose_command_config_filename?:}"

cat >| "${compose_command_config_filename?:}" <<EOF
# Generated by ${script_name?:} on $(date)
COMPOSE_PROJECT_NAME=${compose_project_name}
COMPOSE_SERVER_DOMAIN=${project_domain}

COMPOSE_FILES=${compose_files?:}
EOF

run_command cat "${compose_command_config_filename?:}"

print_info "" "Installing test site"

run_command task test-site:install

print_info "" "Test site \"${site_id}\" installed and available on" "" "  ${project_url}" ""
