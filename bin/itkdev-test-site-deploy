#!/usr/bin/env bash
set -o errexit -o errtrace -o noclobber -o nounset -o pipefail
IFS=$'\n\t'

script_name=$(basename "${BASH_SOURCE[0]}")

abort() {
    echo "$@" >&2
    exit 1
}

is_verbose=false
is_debugging=false
is_affirmative=false

# Global config using `git config` as storage.
config_path="${HOME}/.itkdev-test-site-deploy.config"
[ -e "${config_path}" ] || touch "${config_path}"

_git_config() {
    command="${1:-}"
    shift
    if [[ -z "${command}" ]]; then
        abort "Missing or empty config command"
    fi

    git config "${command}" --file "${config_path}" "$@"
}

_config_get() {
    if [[ $# -ne 1 ]]; then
        abort "Missing config name"
    fi

    name="${1}"
    if [[ -z "${name}" ]]; then
        abort "Empty config name"
    fi

    _git_config get "${name}" || true
}

_config_set() {
    if [[ $# -ne 2 ]]; then
        abort "Missing config name and value"
    fi

    name="${1}"
    if [[ -z "${name}" ]]; then
        abort "Empty config name"
    fi

    value="${2}"
    if [[ -z "${value}" ]]; then
        abort "Empty config value"
    fi

    _git_config set "${name}" "${value}"
}

# Read global config
site_baseDir=$(_config_get "site.baseDir")
site_baseDomain=$(_config_get "site.baseDomain")
compose_command=$(_config_get "compose.command")
compose_commandConfigFilename=$(_config_get "compose.commandConfigFilename")
compose_files=$(_config_get "compose.files")

# Apply default values (cf. https://stackoverflow.com/a/28085062)
: "${site_baseDir:="${HOME}/itkdev/test-sites"}"
: "${compose_command:="itkdev-docker-compose-server"}"
: "${compose_commandConfigFilename:=".env.docker.local"}"
: "${compose_files:="docker-compose.server.test.yml"}"

# Validate config
# Require site.baseDomain to be set unless we're currently setting it.
if [[ "${1:-}" != "config" ]] || \
    [[ "${2:-}" != "set" ]] || \
    [[ "${3:-}" != "site.baseDomain" ]]; then
    if [[ -z "${site_baseDomain}" ]]; then
        abort "Missing or empty config value for site.baseDomain

Set it with

  ${script_name} config set site.baseDomain
"
    fi
fi

usage() {
    if [[ $# -gt 0 ]]; then
        echo "$@" >&2
        echo >&2
    fi
    cat >&2 <<EOF
Usage: ${script_name} [--verbose] [--debug] [--yes] <action> [action arguments and flags]

Actions:
  config: ${script_name} config
  list:   ${script_name} list
  deploy: ${script_name} deploy <repo> <branch> [--install]
  remove: ${script_name} remove <directory>

EOF
    exit 1
}

action_usage() {
    echo "Usage: ${script_name}" "$@" >&2
    echo >&2
    exit 1
}

info() {
    echo "$@"
}

warning() {
    echo "$@"
}

# Get config value from storage or a default value.
config_get_value() {
    if [[ $# -ne 1 ]]; then
        abort "Missing config name"
    fi

    name="${1}"
    if [[ -z "${name}" ]]; then
        abort "Empty config name"
    fi

    value=$(_git_config get "${name}" || true)
    if [[ -z "${value}" ]]; then
        # Try to get value from named varable
        name="${1/./_}"
        value="${!name}"
    fi

    echo "${value}"
}

config() {
    action="list"
    if [[ $# -gt 0 ]]; then
        action="$1"
        shift
    fi

    case "${action}" in
        list)
            names=(
             "site.baseDir"
             "site.baseDomain"
             "compose.command"
             "compose.commandConfigFilename"
             "compose.files"
            )
            for name in "${names[@]}"; do
                echo "${name}: $(config_get_value "${name}")"
            done
            echo
            echo "Use "'`'"${script_name} config set <name>"'`'" to set a configuration value."
            ;;
        set)
            _config_set "$@"
            ;;
        get)
            config_get_value "$@"
            # @todo Make `config get` return default values if not set in Git config storage.
            config_value=$(_config_get "$@")
            config_name="${1/./_}"
            echo "config_name: ${config_name}"
            actual_value="${!config_name}"
            echo "${config_value}" "${actual_value}"
            ;;
        *)
            action_usage "config list|set"
            ;;
    esac
}

list() {
    echo "Projects in ${site_baseDir}"
    echo
    if [ -e "${site_baseDir}" ]; then
        for site_dir in "${site_baseDir}"/*; do
            if [ -d "${site_dir}" ]; then
                site_command_config_path="${site_dir}/${compose_commandConfigFilename}"
                echo "------------------------------------------------------------------------------------------------------------------------"
                echo "Directory:  ${site_dir}"
                echo "Repository: $(git -C "${site_dir}" remote get-url origin)"
                echo "Branch:     $(git -C "${site_dir}" rev-parse --abbrev-ref HEAD)"
                echo
                if [ ! -e "${site_command_config_path}" ]; then
                    warning "Compose command config file ${site_command_config_path} is missing"
                else
                    if [ "${is_verbose}" = true ]; then
                        echo "Run

  ${script_name} remove ${site_dir}

remove this test site.
"
                    fi
                    if [ "${is_debugging}" = true ]; then
                        echo "${site_command_config_path}:"
                        echo
                        cat "${site_command_config_path}"
                        echo

                        (cd "${site_dir}" && "${compose_command}" ps --all)
                    fi
                fi
                echo "------------------------------------------------------------------------------------------------------------------------"
                echo
            fi
        done
    fi
}

deploy() {
    if [[ $# -lt 2 ]]; then
        action_usage "deploy <repo> <branch> [--install]"
    fi

    repo_url="$1"
    shift
    branch="$1"
    shift

    # https://tldp.org/LDP/abs/html/string-manipulation.html
    repo="${repo_url#https://github.com/}"
    project_id=$(echo "${repo}__${branch}" | sed "s@[^a-z0-9-]@-@gi")
    compose_project_name="${project_id}"

    # Our nginx container exits in the upstream hostname gets too long (more than 63 characters?):
    #
    # 2026/01/23 23:01:07 [emerg] 1#1: host not found in upstream "rimi-itk-experiment-test-site--feature-drupal-admin-theme-phpfpm-1" in /etc/nginx/conf.d/default.conf:86
    #
    if [ ${#compose_project_name} -gt 32 ]; then
        compose_project_name="$(echo "${compose_project_name}" | head -c 24)-$(echo "${project_id}" | sha256sum | head -c 16)"
    fi

    # A valid compose project name must consist only of lowercase alphanumeric
    # characters, hyphens, and underscores as well as start with a letter or
    # number.
    compose_project_name=$(echo "${compose_project_name}" | tr "[:upper:]" "[:lower:]")

    project_domain="${project_id}.${site_baseDomain}"
    project_url="https://${project_domain}"
    project_dir=$(echo "${site_baseDir}/${project_id}" | sed "s@[^a-z0-9/-]@@gi")

    # https://stackoverflow.com/questions/2953646/how-can-i-declare-and-use-boolean-variables-in-a-shell-script/21210966
    install_site=false

    if [ ! -e "${project_dir}" ]; then
        install_site=true
    else
        for var in "$@"; do
            case "${var}" in
                --install)
                    install_site=true
                ;;
            esac
        done
    fi

    info "Deploying ${repo}/${branch}"
    info ""
    info "Directory: ${project_dir}"
    info ""

    # Check out the code
    if [ ! -d "${project_dir}" ]; then
        git clone "${repo_url}" --branch "${branch}" "${project_dir}"
    fi

    cd "${project_dir}"
    git fetch
    git reset --hard "origin/${branch}"
    git log -3

    cat >| "${compose_commandConfigFilename}" <<EOF
# Generated by ${script_name} on $(date)
COMPOSE_PROJECT_NAME=${compose_project_name}
COMPOSE_SERVER_DOMAIN=${project_domain}

COMPOSE_FILES=${compose_files}
EOF

    cat "${compose_commandConfigFilename}"

    if [ "${install_site}" = true ]; then
        info "Installing site"
        task test-site:install
    fi

    info "Updating site"
    task test-site:update

    info
    info "Test site deployed on ${project_url}"
}

remove() {
    if [[ $# -lt 1 ]]; then
        action_usage "remove <directory>"
    fi

    directory="$1"
    shift

    if [ "${is_affirmative}" != true ]; then
        read -p "Really remove test site in ${directory} ([yN])? " -n 1 -r
        echo
        if ! [[ $REPLY =~ ^[Yy]$ ]]; then
            return
        fi
    fi

    if [ ! -e "${directory}/${compose_commandConfigFilename}" ]; then
        abort "Directory ${directory} does not look like a test site directory."
    fi

    (cd "${directory}" && "${compose_command}" down --remove-orphans --volumes)
    rm -fr "${directory}"

    info "Test site in ${directory} removed"
}

# -----------------------------------------------------------------------------------------------------------------------

if [[ $# -lt 1 ]]; then
    usage
fi

# Handle global flags
command_arguments=()
for arg in "$@"; do
    case "${arg}" in
        --verbose)
            is_verbose=true
            ;;
        --debug)
            is_debugging=true
            ;;
        --yes)
            is_affirmative=true
            ;;
        *)
            command_arguments+=("${arg}")
            ;;
    esac
done

# Reset the script arguments (cf. https://stackoverflow.com/a/4827707)
if [[ "${#command_arguments[@]}" -eq 0 ]]; then
    usage
else
    set -- "${command_arguments[@]}"
fi

action="$1"
shift

case "${action}" in
    list | deploy | remove | config)
        "${action}" "$@"
        ;;
    *)
      usage "Invalid action: ${action}"
    ;;
esac
