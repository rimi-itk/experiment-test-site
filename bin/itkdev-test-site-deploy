#!/usr/bin/env bash
set -o errexit -o errtrace -o noclobber -o nounset -o pipefail
IFS=$'\n\t'

script_name=$(basename "${BASH_SOURCE[0]}")

abort() {
    echo "$@" >&2
    exit 1
}

is_verbose=false
is_debugging=false
is_affirmative=false
show_help=false

# Global config
config_path="${HOME}/.itkdev-test-site-deploy.config"
[ -e "${config_path}" ] || touch "${config_path}"

# Read config
# @todo https://stackoverflow.com/a/36164878
# shellcheck disable=SC1090
. "${config_path}"

# Apply default values (cf. https://stackoverflow.com/a/28085062)
: "${site_base_dir:="${HOME}/itkdev/test-sites"}"
: "${site_base_domain:=""}"
: "${compose_command:="itkdev-docker-compose-server"}"
: "${compose_command_config_filename:=".env.docker.local"}"
: "${compose_files:="docker-compose.server.test.yml"}"

# Remove any trailing slash
site_base_dir="${site_base_dir#%%/}"

# Validate config
if [[ -z "${site_base_domain}" ]]; then
    abort "Missing or empty config value for site_base_domain. Edit ${config_path} to set it."
fi

usage() {
    if [[ $# -gt 0 ]]; then
        echo "$@" >&2
        echo >&2
    fi
    cat >&2 <<EOF
Usage: ${script_name} [--verbose] [--debug] [--yes] [--help] <command> [command arguments and options]

Commands:
  deploy: Deploy a test site
  list:   List current test sites
  remove: Remove a test site
  config: Show configuration

Options:
  --verbose:    Show more information
  --debug:      Show all commands run
  --yes:        Don't ask for confirmation
  --help:       Show help for a command

Use \`--help\` to get detailed help on a command, e.g. \`${script_name} deploy --help\`.

EOF
    exit 1
}

command_usage() {
    echo "Usage:"
    for arg in "${@}"; do
        echo "${script_name}" "${arg}" >&2
    done
    echo >&2
    exit 1
}

info() {
    echo "$@"
}

warning() {
    echo "Warning:" "$@"
}

config() {
    echo "site_base_dir:                   ${site_base_dir}"
    echo "site_base_domain:                ${site_base_domain}"
    echo
    echo "compose_command:                 ${compose_command}"
    echo "compose_command_config_filename: ${compose_command_config_filename}"
    echo "compose_files:                   ${compose_files}"
    echo
    echo "Edit ${config_path} to change configuration values."
}

list() {
    if [ "${show_help}" = true ]; then
        cat <<EOF
List installed test sites.

Usage: ${script_name} list [--verbose] [--show-compose-config] [--show-compose-containers]

Options:
  --verbose:                    Show additional info on each test site, e.g. the command to re-deploy or remove it
  --show-compose-config:        Show compose config
  --show-compose-containers:    Show all containers in the test site

Example:

  ${script_name} list --verbose

EOF
        return
    fi

    show_compose_config=false
    show_compose_containers=false
    for arg in "$@"; do
        case "${arg}" in
            --show-compose-config)
                show_compose_config=true
                ;;
            --show-compose-containers)
                show_compose_containers=true
                ;;
        esac
    done

    number_of_sites=0
    if [ -e "${site_base_dir}" ]; then
        while IFS= read -r -d '' site_command_config_path; do
            ((++number_of_sites))
            site_dir=$(dirname "${site_command_config_path}")
            site_id="${site_dir##"${site_base_dir}/"}"
            echo "========================================================================================================================"
            echo "ID:         ${site_id}"

            created_at=""
            domain=""
            domain=$(grep COMPOSE_SERVER_DOMAIN "${site_command_config_path}")
            # https://tldp.org/LDP/abs/html/string-manipulation.html
            domain="${domain##*=}"
            # Note: `stat` in macOS (i.e. `/usr/bin/stat`) does not support `--format`
            if stat --format '%w' "${site_command_config_path}" > /dev/null 2>&1; then
                created_at=$(stat --format '%w' "${site_command_config_path}")
            fi

            echo "Repository: $(git -C "${site_dir}" remote get-url origin)"
            echo "Branch:     $(git -C "${site_dir}" rev-parse --abbrev-ref HEAD)"
            if [ -n "${created_at}" ]; then
                echo "Created at: ${created_at}"
            fi
            if [ -n "${domain}" ]; then
                echo "URL:        https://${domain}"
            fi

            if [ "${is_verbose}" = true ]; then
                echo "------------------------------------------------------------------------------------------------------------------------"
                cat <<EOF

Re-deploy site by running

  ${script_name} deploy ${site_id}

Remove it by running

  ${script_name} remove ${site_id}

EOF
            fi
            if [ "${show_compose_config}" = true ]; then
                echo "------------------------------------------------------------------------------------------------------------------------"
                echo "${site_command_config_path}:"
                echo
                cat "${site_command_config_path}"
                echo
            fi
            if [ "${show_compose_containers}" = true ]; then
                echo "------------------------------------------------------------------------------------------------------------------------"
                (cd "${site_dir}" && "${compose_command}" ps --all)
            fi
            echo "========================================================================================================================"
            echo
        done < <(find "${site_base_dir}" -type f -name "${compose_command_config_filename}" -print0)
    fi
    if [ "${number_of_sites}" -eq 0 ]; then
        info "No test sites deployed."
    fi
}

deploy() {
    if [ "${show_help}" = true ]; then
        cat <<EOF
Deploy a test site.

Usage: ${script_name} deploy <repo> <branch> [--install]
       ${script_name} deploy <ID> [--install]

Arguments:
  <repo>:       The URL of a git repository
  <branch>:     The branch
  <ID>:         ID of a previously deployed test site (cf. \`${script_name} list\`)

Options:
  --install:    Force installation of the test site even if it already exists

Example:

  ${script_name} deploy https://github.com/rimi-itk/experiment-test-site feature/drupal-admin-theme

EOF
        return
    fi

    arguments=()
    # https://stackoverflow.com/questions/2953646/how-can-i-declare-and-use-boolean-variables-in-a-shell-script/21210966
    install_site=false

    for arg in "$@"; do
        case "${arg}" in
            --install)
                install_site=true
                ;;
            --*)
                abort "The \"${arg}\" option does not exist."
                ;;
            *)
                arguments+=("${arg}")
                ;;
        esac
    done

    # Reset the function arguments (cf. https://stackoverflow.com/a/4827707)
    # https://www.gnu.org/software/bash/manual/html_node/The-Set-Builtin.html
    set -- "${arguments[@]}"

    if [[ $# -lt 1 ]]; then
        command_usage "deploy <repo> <branch> [--install]" \
            "deploy <ID> [--install]"
    fi

    if [[ $# -eq 1 ]]; then
        site_id="$1"
        site_dir="${site_base_dir}/${site_id}"
        if [ ! -e "${site_dir}" ]; then
            abort "\"${site_id}\" is not a valid site ID"
        fi

        repo_url=$(git -C "${site_dir}" remote get-url origin)
        branch=$(git -C "${site_dir}" rev-parse --abbrev-ref HEAD)
    else
        repo_url="$1"
        shift
        branch="$1"
        shift
    fi

    # https://tldp.org/LDP/abs/html/string-manipulation.html
    # @todo Handle other sources than GitHub
    repo="${repo_url#https://github.com/}"

    # Handle local repositories
    if realpath "${repo_url}" > /dev/null 2>&1; then
        repo_url=$(realpath "${repo_url}")
        repo=$(basename "${repo_url}")
    fi

    site_id=$(echo "${repo}__${branch}" | sed "s@[^a-z0-9-]@-@gi")
    compose_project_name="${site_id}"

    # Our nginx container exits in the upstream hostname gets too long (more than 63 characters?):
    #
    # 2026/01/23 23:01:07 [emerg] 1#1: host not found in upstream "rimi-itk-experiment-test-site--feature-drupal-admin-theme-phpfpm-1" in /etc/nginx/conf.d/default.conf:86
    #
    if [ ${#compose_project_name} -gt 32 ]; then
        compose_project_name="$(echo "${compose_project_name}" | head -c 24)-$(echo "${site_id}" | sha256sum | head -c 16)"
    fi

    # A valid compose project name must consist only of lowercase alphanumeric
    # characters, hyphens, and underscores as well as start with a letter or
    # number.
    # @todo Validate the compose project name.
    compose_project_name=$(echo "${compose_project_name}" | tr "[:upper:]" "[:lower:]")

    project_domain="${site_id}.${site_base_domain}"
    project_url="https://${project_domain}"
    project_dir=$(echo "${site_base_dir}/${site_id}" | sed "s@[^a-z0-9/-]@@gi")

    if [ ! -e "${project_dir}" ]; then
        install_site=true
    fi

    info "Deploying ${site_id}"
    info ""

    # Check out the code
    if [ ! -d "${project_dir}" ]; then
        git clone "${repo_url}" --branch "${branch}" "${project_dir}"
    fi

    cd "${project_dir}"
    git fetch
    git reset --hard "origin/${branch}"
    git log -3

    cat >| "${compose_command_config_filename}" <<EOF
# Generated by ${script_name} on $(date)
COMPOSE_PROJECT_NAME=${compose_project_name}
COMPOSE_SERVER_DOMAIN=${project_domain}

COMPOSE_FILES=${compose_files}
EOF

    cat "${compose_command_config_filename}"

    if [ "${install_site}" = true ]; then
        info "Installing site"
        task test-site:install
    fi

    info "Updating site"
    task test-site:update

    info
    info "Test site deployed on ${project_url}"
}

remove() {
        if [ "${show_help}" = true ]; then
        cat <<EOF
Remove a test site.

Usage: ${script_name} remove <ID>

Arguments:
  <ID>:  The test site ID (cf. \`${script_name} list\`)

Options:
  --yes:        Don't ask for confirmation before deleting test site.

Example:

  ${script_name} remove rimi-itk-experiment-test-site--drupal-II --yes

EOF
        return
    fi

    if [[ $# -lt 1 ]]; then
        command_usage "remove <id>"
    fi

    site_id="$1"
    shift


    if [ "${is_affirmative}" != true ]; then
        read -p "Really remove test site ${site_id} ([yN])? " -n 1 -r
        echo
        if ! [[ $REPLY =~ ^[Yy]$ ]]; then
            return
        fi
    fi

    site_dir="${site_base_dir}/${site_id}"
    if [ ! -e "${site_dir}/${compose_command_config_filename}" ]; then
        abort "Site_Id ${site_id} does not look like a test site site_id."
    fi

    (cd "${site_dir}" && "${compose_command}" down --remove-orphans --volumes)
    rm -fr "${site_dir}"

    info
    info "Test site ${site_id} removed"
}

# -----------------------------------------------------------------------------------------------------------------------

if [[ $# -lt 1 ]]; then
    usage
fi

# Handle global flags
command_arguments=()
for arg in "$@"; do
    case "${arg}" in
        --debug)
            is_debugging=true
            ;;
        --help)
            show_help=true
            ;;
        --verbose)
            is_verbose=true
            ;;
        --yes)
            is_affirmative=true
            ;;
        *)
            command_arguments+=("${arg}")
            ;;
    esac
done

# Reset the script arguments (cf. https://stackoverflow.com/a/4827707)
if [[ "${#command_arguments[@]}" -eq 0 ]]; then
    usage
else
    # https://www.gnu.org/software/bash/manual/html_node/The-Set-Builtin.html
    set -- "${command_arguments[@]}"
fi

command="$1"
shift

case "${command}" in
    list | deploy | remove | config)
        if [ "${is_debugging}" = true ]; then
            # https://www.gnu.org/software/bash/manual/html_node/The-Set-Builtin.html
            # PS4=""
            set -x
        fi
        "${command}" "$@"
        ;;
    *)
      usage "Invalid command: ${command}"
    ;;
esac
