#!/usr/bin/env bash
set -o errexit -o errtrace -o noclobber -o nounset -o pipefail
IFS=$'\n\t'

script_name=$(basename "${BASH_SOURCE[0]}")

abort() {
    echo "$@" >&2
    exit 1
}

is_verbose=false
is_debugging=false
is_affirmative=false

# Global config
config_path="${HOME}/.itkdev-test-site-deploy.config"
[ -e "${config_path}" ] || touch "${config_path}"

# shellcheck disable=SC1090
. "${config_path}"

# Apply default values (cf. https://stackoverflow.com/a/28085062)
: "${site_base_dir:="${HOME}/itkdev/test-sites"}"
: "${site_base_domain:=""}"
: "${compose_command:="itkdev-docker-compose-server"}"
: "${compose_command_config_filename:=".env.docker.local"}"
: "${compose_files:="docker-compose.server.test.yml"}"

# Validate config
if [[ -z "${site_base_domain}" ]]; then
    abort "Missing or empty config value for site_base_domain. Edit ${config_path} to set it."
fi

usage() {
    if [[ $# -gt 0 ]]; then
        echo "$@" >&2
        echo >&2
    fi
    cat >&2 <<EOF
Usage: ${script_name} [--verbose] [--debug] [--yes] <action> [action arguments and flags]

Actions:
  config: ${script_name} config
  list:   ${script_name} list
  deploy: ${script_name} deploy <repo> <branch> [--install]
  remove: ${script_name} remove <directory>

EOF
    exit 1
}

action_usage() {
    echo "Usage: ${script_name}" "$@" >&2
    echo >&2
    exit 1
}

info() {
    echo "$@"
}

warning() {
    echo "$@"
}

config() {
    echo "site_base_dir:                   ${site_base_dir}"
    echo "site_base_domain:                ${site_base_domain}"
    echo
    echo "compose_command:                 ${compose_command}"
    echo "compose_command_config_filename: ${compose_command_config_filename}"
    echo "compose_files:                   ${compose_files}"
    echo
    echo "Edit ${config_path} to change configuration values."
}

list() {
    echo "Projects in ${site_base_dir}"
    echo
    if [ -e "${site_base_dir}" ]; then
        for site_dir in "${site_base_dir}"/*; do
            if [ -d "${site_dir}" ]; then
                site_command_config_path="${site_dir}/${compose_command_config_filename}"
                echo "------------------------------------------------------------------------------------------------------------------------"
                echo "Directory:  ${site_dir}"
                echo "Repository: $(git -C "${site_dir}" remote get-url origin)"
                echo "Branch:     $(git -C "${site_dir}" rev-parse --abbrev-ref HEAD)"
                echo
                if [ ! -e "${site_command_config_path}" ]; then
                    warning "Compose command config file ${site_command_config_path} is missing"
                else
                    if [ "${is_verbose}" = true ]; then
                        echo "Run

  ${script_name} remove ${site_dir}

to remove this test site.
"
                    fi
                    if [ "${is_debugging}" = true ]; then
                        echo "${site_command_config_path}:"
                        echo
                        cat "${site_command_config_path}"
                        echo

                        (cd "${site_dir}" && "${compose_command}" ps --all)
                    fi
                fi
                echo "------------------------------------------------------------------------------------------------------------------------"
                echo
            fi
        done
    fi
}

deploy() {
    if [[ $# -lt 2 ]]; then
        action_usage "deploy <repo> <branch> [--install]"
    fi

    repo_url="$1"
    shift
    branch="$1"
    shift

    # https://tldp.org/LDP/abs/html/string-manipulation.html
    repo="${repo_url#https://github.com/}"
    project_id=$(echo "${repo}__${branch}" | sed "s@[^a-z0-9-]@-@gi")
    compose_project_name="${project_id}"

    # Our nginx container exits in the upstream hostname gets too long (more than 63 characters?):
    #
    # 2026/01/23 23:01:07 [emerg] 1#1: host not found in upstream "rimi-itk-experiment-test-site--feature-drupal-admin-theme-phpfpm-1" in /etc/nginx/conf.d/default.conf:86
    #
    if [ ${#compose_project_name} -gt 32 ]; then
        compose_project_name="$(echo "${compose_project_name}" | head -c 24)-$(echo "${project_id}" | sha256sum | head -c 16)"
    fi

    # A valid compose project name must consist only of lowercase alphanumeric
    # characters, hyphens, and underscores as well as start with a letter or
    # number.
    compose_project_name=$(echo "${compose_project_name}" | tr "[:upper:]" "[:lower:]")

    project_domain="${project_id}.${site_base_domain}"
    project_url="https://${project_domain}"
    project_dir=$(echo "${site_base_dir}/${project_id}" | sed "s@[^a-z0-9/-]@@gi")

    # https://stackoverflow.com/questions/2953646/how-can-i-declare-and-use-boolean-variables-in-a-shell-script/21210966
    install_site=false

    if [ ! -e "${project_dir}" ]; then
        install_site=true
    else
        for var in "$@"; do
            case "${var}" in
                --install)
                    install_site=true
                ;;
            esac
        done
    fi

    info "Deploying ${repo}/${branch}"
    info ""
    info "Directory: ${project_dir}"
    info ""

    # Check out the code
    if [ ! -d "${project_dir}" ]; then
        git clone "${repo_url}" --branch "${branch}" "${project_dir}"
    fi

    cd "${project_dir}"
    git fetch
    git reset --hard "origin/${branch}"
    git log -3

    cat >| "${compose_command_config_filename}" <<EOF
# Generated by ${script_name} on $(date)
COMPOSE_PROJECT_NAME=${compose_project_name}
COMPOSE_SERVER_DOMAIN=${project_domain}

COMPOSE_FILES=${compose_files}
EOF

    cat "${compose_command_config_filename}"

    if [ "${install_site}" = true ]; then
        info "Installing site"
        task test-site:install
    fi

    info "Updating site"
    task test-site:update

    info
    info "Test site deployed on ${project_url}"
}

remove() {
    if [[ $# -lt 1 ]]; then
        action_usage "remove <directory>"
    fi

    directory="$1"
    shift

    if [ "${is_affirmative}" != true ]; then
        read -p "Really remove test site in ${directory} ([yN])? " -n 1 -r
        echo
        if ! [[ $REPLY =~ ^[Yy]$ ]]; then
            return
        fi
    fi

    if [ ! -e "${directory}/${compose_command_config_filename}" ]; then
        abort "Directory ${directory} does not look like a test site directory."
    fi

    (cd "${directory}" && "${compose_command}" down --remove-orphans --volumes)
    rm -fr "${directory}"

    info "Test site in ${directory} removed"
}

# -----------------------------------------------------------------------------------------------------------------------

if [[ $# -lt 1 ]]; then
    usage
fi

# Handle global flags
command_arguments=()
for arg in "$@"; do
    case "${arg}" in
        --verbose)
            is_verbose=true
            ;;
        --debug)
            is_debugging=true
            ;;
        --yes)
            is_affirmative=true
            ;;
        *)
            command_arguments+=("${arg}")
            ;;
    esac
done

# Reset the script arguments (cf. https://stackoverflow.com/a/4827707)
if [[ "${#command_arguments[@]}" -eq 0 ]]; then
    usage
else
    set -- "${command_arguments[@]}"
fi

action="$1"
shift

case "${action}" in
    list | deploy | remove | config)
        "${action}" "$@"
        ;;
    *)
      usage "Invalid action: ${action}"
    ;;
esac
